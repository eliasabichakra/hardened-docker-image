name: Base Image Security Comparison

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  scan-base-images:
    runs-on: ubuntu-latest

    steps:
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin
          trivy version

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin
          grype version

      - name: Login to DHI Registry
        run: |
          echo "${{ secrets.DHI_PASSWORD }}" | docker login -u "${{ secrets.DHI_USERNAME }}" --password-stdin dhi.io

      - name: Scan base images
        run: |
          IMAGES=(
            "node:25-alpine"
            "node:25-slim"
            "dhi.io/node:25-debian13-dev"
            "dhi.io/node:25-alpine3.22"
            "dhi.io/node:25-debian13-sfw-ent-dev"
          )

          echo "## ðŸ›¡ï¸ Base Image Vulnerability Summary" >> $GITHUB_STEP_SUMMARY

          for IMAGE in "${IMAGES[@]}"; do
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Image: \`$IMAGE\`" >> $GITHUB_STEP_SUMMARY

            # --- Trivy JSON ---
            TRIVY_JSON=$(trivy image "$IMAGE" --severity HIGH,CRITICAL --scanners vuln --format json)
            TRIVY_HIGH=$(echo "$TRIVY_JSON" | jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")]')
            TRIVY_CRITICAL=$(echo "$TRIVY_JSON" | jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")]')

            # --- Grype JSON ---
            GRYPE_JSON=$(grype "$IMAGE" -o json)
            GRYPE_HIGH=$(echo "$GRYPE_JSON" | jq '[.matches[] | select(.vulnerability.severity=="High")]')
            GRYPE_CRITICAL=$(echo "$GRYPE_JSON" | jq '[.matches[] | select(.vulnerability.severity=="Critical")]')

            # --- Trivy table ---
            echo "**Trivy HIGH Vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            if [ $(echo "$TRIVY_HIGH" | jq 'length') -eq 0 ]; then
              echo "_None_" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Vulnerability | Package | Version | Fix Version |" >> $GITHUB_STEP_SUMMARY
              echo "|--------------|--------|--------|------------|" >> $GITHUB_STEP_SUMMARY
              echo "$TRIVY_HIGH" | jq -r '.[] | "| \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") |"' >> $GITHUB_STEP_SUMMARY
            fi

            echo "**Trivy CRITICAL Vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            if [ $(echo "$TRIVY_CRITICAL" | jq 'length') -eq 0 ]; then
              echo "_None_" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Vulnerability | Package | Version | Fix Version |" >> $GITHUB_STEP_SUMMARY
              echo "|--------------|--------|--------|------------|" >> $GITHUB_STEP_SUMMARY
              echo "$TRIVY_CRITICAL" | jq -r '.[] | "| \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") |"' >> $GITHUB_STEP_SUMMARY
            fi

            # --- Grype table ---
            echo "**Grype HIGH Vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            if [ $(echo "$GRYPE_HIGH" | jq 'length') -eq 0 ]; then
              echo "_None_" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Vulnerability | Package | Version | Fix Version |" >> $GITHUB_STEP_SUMMARY
              echo "|--------------|--------|--------|------------|" >> $GITHUB_STEP_SUMMARY
              echo "$GRYPE_HIGH" | jq -r '.[] | "| \(.vulnerability.id) | \(.artifact.name) | \(.artifact.version) | \(.vulnerability.fixedInVersion // "-") |"' >> $GITHUB_STEP_SUMMARY
            fi

            echo "**Grype CRITICAL Vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            if [ $(echo "$GRYPE_CRITICAL" | jq 'length') -eq 0 ]; then
              echo "_None_" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Vulnerability | Package | Version | Fix Version |" >> $GITHUB_STEP_SUMMARY
              echo "|--------------|--------|--------|------------|" >> $GITHUB_STEP_SUMMARY
              echo "$GRYPE_CRITICAL" | jq -r '.[] | "| \(.vulnerability.id) | \(.artifact.name) | \(.artifact.version) | \(.vulnerability.fixedInVersion // "-") |"' >> $GITHUB_STEP_SUMMARY
            fi
          done
