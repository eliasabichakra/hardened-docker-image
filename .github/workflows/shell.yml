name: Test DHI Hardened Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-dhi-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to DHI Registry
        run: |
          echo "${{ secrets.DHI_PASSWORD }}" | docker login -u "${{ secrets.DHI_USERNAME }}" --password-stdin dhi.io

      - name: Pull DHI Node Image
        run: |
          docker pull dhi.io/node:25-alpine3.22

      - name: Run Container
        run: |
          # Keep container alive using Node itself
          docker run -d --name dhi_test_container dhi.io/node:25-alpine3.22 node -e "setTimeout(()=>{}, 300000)"

      - name: Attempt to Open Shell
        run: |
          echo "Trying to detect available shells inside the hardened container..."
          docker exec dhi_test_container sh -c "echo 'sh exists'" || echo "sh not available"
          docker exec dhi_test_container bash -c "echo 'bash exists'" || echo "bash not available"
          docker exec dhi_test_container ash -c "echo 'ash exists'" || echo "ash not available"
      - name: Cleanup
        run: |
          docker rm -f dhi_test_container
